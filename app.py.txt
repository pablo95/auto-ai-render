import os
from flask import Flask, request, jsonify
import openai

app = Flask(__name__)

openai.api_key = os.getenv("OPENAI_API_KEY")

@app.route("/")
def home():
    return "DescriptoAI - API Ecommerce Description - OK"

@app.route("/generate", methods=["POST"])
def generate_description():
    data = request.json or {}
    title = data.get("title", "")
    features = data.get("features", "")
    tone = data.get("tone", "persuasif")
    length = data.get("length", "short")

    if not title:
        return jsonify({"error": "title is required"}), 400

    prompt = f"""
Écris une description produit optimisée.
Titre: {title}
Caractéristiques: {features}
Ton: {tone}
Longueur: {length}
"""

    try:
        resp = openai.ChatCompletion.create(
            model="gpt-4o-mini",
            messages=[{"role":"system","content":"Tu es un expert e-commerce."},
                      {"role":"user","content":prompt}],
            max_tokens=300,
            temperature=0.2
        )

        text = resp["choices"][0]["message"]["content"].strip()
        return jsonify({"description": text})

    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.getenv("PORT", 5000)))
